#
# 
# https://github.com/kubernetes/kubernetes/blob/master/cmd/kubeadm/app/apis/kubeadm/v1beta2/doc.go
# https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/control-plane-flags/
#
apiVersion: kubeadm.k8s.io/v1beta2
kind: InitConfiguration
localAPIEndpoint:
  advertiseAddress: __LB_IP_ADDR__
  bindPort: 6443
nodeRegistration:
  name: __NODE_HOSTNAME__
---
apiVersion: kubeadm.k8s.io/v1beta2
kind: ClusterConfiguration
kubernetesVersion: v1.16.8
controlPlaneEndpoint: "__NODE_IP_ADDR__:6443"
apiServer:
  extraArgs:
    advertise-address: __LB_IP_ADDR__
    allow-privileged: "true"
    authorization-mode: Node,RBAC
    client-ca-file: /etc/kubernetes/pki/ca.crt
    enable-admission-plugins: NodeRestriction
    enable-bootstrap-token-auth: "true"
    insecure-port: '0'
    etcd-cafile:   /etc/kubernetes/pki/etcd/ca.crt
    etcd-certfile: /etc/kubernetes/pki/apiserver-etcd-client.crt
    etcd-keyfile:  /etc/kubernetes/pki/apiserver-etcd-client.key
    etcd-servers:  https://127.0.0.1:2379,https://__NODE_IP_ADDR__:2379
    kubelet-client-certificate: /etc/kubernetes/pki/apiserver-kubelet-client.crt
    kubelet-client-key: /etc/kubernetes/pki/apiserver-kubelet-client.key
    kubelet-preferred-address-types: InternalIP,ExternalIP,Hostname
    proxy-client-cert-file: /etc/kubernetes/pki/front-proxy-client.crt
    proxy-client-key-file: /etc/kubernetes/pki/front-proxy-client.key
    requestheader-allowed-names: front-proxy-client
    requestheader-client-ca-file: /etc/kubernetes/pki/front-proxy-ca.crt
    requestheader-extra-headers-prefix: X-Remote-Extra-
    requestheader-group-headers: X-Remote-Group
    requestheader-username-headers: X-Remote-User
    secure-port: '6443'
    service-account-key-file: /etc/kubernetes/pki/sa.pub
    service-cluster-ip-range: 10.32.0.0/24
    tls-cert-file: /etc/kubernetes/pki/apiserver.crt
    tls-private-key-file: /etc/kubernetes/pki/apiserver.key
  certSANs:
  - "__NODE_IP_ADDR__"

networking:
  serviceSubnet: "10.32.0.0/24"
  podSubnet: "10.244.0.0/16"
  dnsDomain: "example.com"

etcd:
  local:
    imageRepository: "k8s.gcr.io"
    imageTag: "3.3.15-0"
    dataDir: "/var/lib/etcd"
    extraArgs:
       name: __NODE_HOSTNAME__
       listen-client-urls: https://127.0.0.1:2379,https://__NODE_IP_ADDR__:2379
       advertise-client-urls: https://__NODE_IP_ADDR__:2379
       cert-file: /etc/kubernetes/pki/etcd/server.crt 
       client-cert-auth: "true"
       data-dir: /var/lib/etcd 
       initial-advertise-peer-urls: https://__NODE_IP_ADDR__:2380
       initial-cluster: __NODE_HOSTNAME__=https://__NODE_IP_ADDR__:2380
       key-file: /etc/kubernetes/pki/etcd/server.key 
       listen-peer-urls: https://172.16.2.11:2380
       listen-metrics-urls: http://127.0.0.1:2381
       peer-cert-file: /etc/kubernetes/pki/etcd/peer.crt 
       peer-client-cert-auth: "true"
       peer-key-file: /etc/kubernetes/pki/etcd/peer.key 
       peer-trusted-ca-file: /etc/kubernetes/pki/etcd/ca.crt 
       snapshot-count: '10000'
       trusted-ca-file: /etc/kubernetes/pki/etcd/ca.crt
    serverCertSANs:
    - "__NODE_HOSTNAME__"
    peerCertSANs:
    - "172.16.2.11"
    - "172.16.2.12"
    - "172.16.2.13"


